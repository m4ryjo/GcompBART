#' Extended Hypers for GcompBART (wraps SoftBart::Hypers)
#'
#' This function calls SoftBart::Hypers() to construct the base hyper-parameter
#' list and then extends it with GcompBART-specific fields (`alpha_vec`, `eta`,
#' `phi`, plus `tgroup` and `tgroup_size`). By delegating to SoftBart, you
#' inherit its defaults and future improvements without duplicating logic.
#'
#' @param X,Y,group Same as in SoftBart::Hypers()
#' @param tgroup Integer-like vector (length ncol(X)); GcompLDART-specific grouping.
#'   If NULL, a default is used.
#' @param alpha_vec,eta,phi Numeric; GcompLDART-specific extensions.
#' @inheritParams SoftBart::Hypers
#' @return list: all SoftBart fields + alpha_vec, eta, phi, tgroup, tgroup_size
#' @export
Hypers <- function(
    X, Y, group = NULL, tgroup = NULL,
    alpha = 1, eta = 1, phi = 1, alpha_vec = 1,
    beta = 2, gamma = 0.95, k = 2,
    sigma_hat = NULL, shape = 1, width = 0.1, num_tree = 20,
    alpha_scale = NULL, alpha_shape_1 = 0.5,
    alpha_shape_2 = 1, tau_rate = 10, num_tree_prob = NULL,
    temperature = 1.0, weights = NULL, normalize_Y = TRUE
) {
  # 1) Build the base structure using SoftBart (all defaults are preserved)
  sb <- SoftBart::Hypers(
    X = X, Y = Y, group = group,
    alpha = alpha, beta = beta, gamma = gamma, k = k,
    sigma_hat = sigma_hat, shape = shape, width = width, num_tree = num_tree,
    alpha_scale = alpha_scale, alpha_shape_1 = alpha_shape_1,
    alpha_shape_2 = alpha_shape_2, tau_rate = tau_rate,
    num_tree_prob = num_tree_prob, temperature = temperature,
    weights = weights, normalize_Y = normalize_Y
  )

  # 2) Inject GcompLDART-specific fields
  sb$alpha_vec <- alpha_vec
  sb$eta       <- eta
  sb$phi       <- phi

  # 3) tgroup handling
  if (is.null(tgroup)) {
    sb$tgroup <- rep(1L, ncol(X)) - 1L
  } else {
    tg <- as.integer(tgroup)
    sb$tgroup <- tg + ifelse(tg == 0L, 1L, 0L) * max(tg)
  }
  sb$tgroup_size <- as.vector(table(sb$tgroup))

  return(sb)
}



#' Extended Opts for GcompLDART (wraps SoftBart::Opts)
#' Builds the base options via SoftBart::Opts() and then extends with the
#' GcompBART-specific update flags for time-varying pieces and alpha_vec.
#'
#' @param num_burn,num_thin,num_save,num_print,update_sigma_mu,update_s,
#'   update_alpha,update_beta,update_gamma,update_tau,update_tau_mean,
#'   update_sigma,cache_trees Same semantics as in SoftBart::Opts().
#' @param update_tvp,update_eta,update_phi,update_alpha_vec Logical flags;
#'   GcompBART-specific extensions (ignored by SoftBart).
#' @return A named list identical to SoftBart::Opts() **plus**
#'   `update_tvp`, `update_eta`, `update_phi`, `update_alpha_vec`.
#' @export
Opts <- function(
    num_burn = 2500, num_thin = 1, num_save = 2500, num_print = 100,
    update_sigma_mu = TRUE, update_s = TRUE, update_alpha = TRUE,
    update_beta = FALSE, update_gamma = FALSE, update_tau = TRUE,
    update_tau_mean = FALSE, update_sigma = TRUE,
    cache_trees = TRUE,
    # --- GcompLDART extensions (default FALSE to preserve SoftBart behavior) ---
    update_tvp = FALSE, update_eta = FALSE, update_phi = FALSE,
    update_alpha_vec = FALSE
) {
  # 1) Build the base list with SoftBart (covers all shared fields + defaults)
  sb <- SoftBart::Opts(
    num_burn = num_burn, num_thin = num_thin, num_save = num_save,
    num_print = num_print,
    update_sigma_mu = update_sigma_mu, update_s = update_s,
    update_alpha = update_alpha,
    update_beta = update_beta, update_gamma = update_gamma,
    update_tau = update_tau, update_tau_mean = update_tau_mean,
    update_sigma = update_sigma,
    cache_trees = cache_trees
  )

  # 2) Inject GcompBART-only flags
  sb$update_tvp        <- isTRUE(update_tvp)
  sb$update_eta        <- isTRUE(update_eta)
  sb$update_phi        <- isTRUE(update_phi)
  sb$update_alpha_vec  <- isTRUE(update_alpha_vec)

  # 3) Keep explicit false for update_num_tree to mirror your current shape
  if (is.null(sb$update_num_tree)) sb$update_num_tree <- FALSE

  return(sb)
}

MakeForest <- function(hypers, opts) {
  mf <- Rcpp::Module(module = "mod_forest", PACKAGE = "SoftBart")
  return(new(mf$Forest, hypers, opts))
}
